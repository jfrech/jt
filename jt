#! /bin/zsh

jt_repository="https://raw.githubusercontent.com/jfrech/jt/master"
jt_local="$(dirname "$0")"

require () {
    [ -z "$(command -v $1)" ] && echo "Please install '$1'." && exit 1 }

require curl
require make
require gcc


tool="$1"
tool_args="${@:2}"

fail () {
    echo "Trying to call tool '$tool': $1"
    exit 1 }

download () {
    mkdir -p "$jt_local/toolbox/"
    curl --fail --silent "$jt_repository/toolbox/$tool.tar.gz" \
        > "$jt_local/toolbox/$tool.tar.gz" \
        || fail "Could not curl '$jt_repository/toolbox/$tool.tar.gz'." }

unpack () {
    [ ! -f "$jt_local/toolbox/$tool.tar.gz" ] \
        && fail "Could not find '$jt_local/toolbox/$tool.tar.gz'."
    [ -e "$jt_local/toolbox/$tool" ] \
        && fail "Could not unpack '$tool'" \
            "since '$jt_local/toolbox/$tool' already exists."

    tar -xf "$1.tar.gz" -C "$jt_local/toolbox"
    [ -f "$jt_local/toolbox/$1/Makefile" ] && make -C "$jt_local/toolbox/$tool"

    [ ! -f "$jt_local/toolbox/$tool/$tool" ] \
        && fail "Could not unpack '$tool'."
    chmod +x "$jt_local/toolbox/$tool/$tool" }

run () {
    [ ! -f "$jt_local/toolbox/$tool/$tool" ] \
        && fail "Could not find tool '$tool'."
    "$jt_local/toolbox/$tool/$tool" "$tool_args" }


[ ! -f "$jt_local/toolbox/$1.tar.gz" ] && download
[ ! -d "$jt_local/toolbox/$1" ] && unpack
run
